{% extends "base.html" %}

{% block title %}py-phone-caller Scheduled Calls{% endblock %}

{% block content %}
<div class="container-fluid main-container px-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="page-header mb-0 text-start">Scheduled Calls</h2>
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleCallModal">
                <i class="bi bi-calendar-plus me-1"></i> New Scheduled Call
            </button>
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="bi bi-file-earmark-excel me-1"></i> Export CSV
            </button>
        </div>
    </div>

    <!-- Search Box -->
    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-body p-3">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <form method="get" action="{{ url_for('schedule_call_blueprint.schedule_call') }}" class="d-flex">
                        <input type="hidden" name="per_page" value="{{ per_page }}">
                        <input type="hidden" name="sort_by" value="{{ sort_by }}">
                        <input type="hidden" name="sort_order" value="{{ sort_order }}">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                            <input class="form-control border-start-0 ps-0" type="search" placeholder="Search scheduled calls..."
                                   aria-label="Search" name="search" value="{{ search_query }}">
                            {% if search_query %}
                            <a href="{{ url_for('schedule_call_blueprint.schedule_call', per_page=per_page, sort_by=sort_by, sort_order=sort_order) }}"
                               class="btn btn-outline-secondary d-flex align-items-center"><i class="bi bi-x-lg"></i></a>
                            {% endif %}
                            <button class="btn btn-primary px-4" type="submit">Search</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container table-responsive border-0 shadow-sm">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th>
                    <a href="{{ url_for('schedule_call_blueprint.schedule_call', sort_by='element', sort_order='asc' if sort_by != 'element' or sort_order == 'desc' else 'desc', page=page, per_page=per_page, search=search_query) }}" class="text-dark text-decoration-none d-flex align-items-center gap-1">
                        Element
                        {% if sort_by == 'element' %}
                            <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}-short text-primary"></i>
                        {% endif %}
                    </a>
                </th>
                <th>Phone Number</th>
                <th>Message</th>
                <th>
                    <a href="{{ url_for('schedule_call_blueprint.schedule_call', sort_by='inserted_time', sort_order='asc' if sort_by != 'inserted_time' or sort_order == 'desc' else 'desc', page=page, per_page=per_page, search=search_query) }}" class="text-dark text-decoration-none d-flex align-items-center gap-1">
                        Inserted At
                        {% if sort_by == 'inserted_time' %}
                            <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}-short text-primary"></i>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('schedule_call_blueprint.schedule_call', sort_by='scheduled_time', sort_order='asc' if sort_by != 'scheduled_time' or sort_order == 'desc' else 'desc', page=page, per_page=per_page, search=search_query) }}" class="text-dark text-decoration-none d-flex align-items-center gap-1">
                        Scheduled Time
                        {% if sort_by == 'scheduled_time' %}
                            <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}-short text-primary"></i>
                        {% endif %}
                    </a>
                </th>
            </tr>
            </thead>
            <tbody>
            {% for element in paginated_data %}
            {% set call = table_data[element] %}
            <tr>
                <td><span class="badge bg-light text-dark border">{{ element }}</span></td>
                <td><span class="fw-bold text-primary">{{ call.get("phone") }}</span></td>
                <td class="small">{{ call.get("message") }}</td>
                <td class="small text-muted">{{ call.get("inserted_at").strftime("%d/%m/%Y %H:%M:%S") if call.get("inserted_at") else "-" }}</td>
                <td>
                    <span class="badge {{ 'bg-primary-subtle text-primary border border-primary-subtle' if call.get('scheduled_at') > now else 'bg-secondary-subtle text-secondary border border-secondary-subtle' }}">
                        <i class="bi bi-calendar-event me-1"></i>
                        {{ call.get("scheduled_at").strftime("%d/%m/%Y %H:%M:%S") if call.get("scheduled_at") else "-" }}
                    </span>
                </td>
            </tr>
            {% endfor %}
            {% if paginated_data|length == 0 %}
            <tr>
                <td colspan="5" class="text-center py-5 text-muted">
                    <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                    No scheduled calls found{% if search_query %} for "{{ search_query }}"{% endif %}
                </td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 gap-3">
        <div class="order-2 order-md-1">
            <form method="get" action="{{ url_for('schedule_call_blueprint.schedule_call') }}" class="d-flex align-items-center">
                {% if search_query %}<input type="hidden" name="search" value="{{ search_query }}">{% endif %}
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                <input type="hidden" name="sort_order" value="{{ sort_order }}">
                <div class="input-group input-group-sm">
                    <label class="input-group-text bg-light border-end-0" for="items-per-page">Items per page:</label>
                    <select class="form-select border-start-0" id="items-per-page" name="per_page" onchange="this.form.submit()">
                        {% for option in [5, 10, 25, 50, 100] %}
                        <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>

        {% if total_pages > 1 %}
        <nav aria-label="Page navigation" class="order-1 order-md-2">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('schedule_call_blueprint.schedule_call', page=page-1, per_page=per_page, search=search_query, sort_by=sort_by, sort_order=sort_order) if page > 1 else '#' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('schedule_call_blueprint.schedule_call', page=p, per_page=per_page, search=search_query, sort_by=sort_by, sort_order=sort_order) }}">{{ p }}</a>
                </li>
                {% endfor %}
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('schedule_call_blueprint.schedule_call', page=page+1, per_page=per_page, search=search_query, sort_by=sort_by, sort_order=sort_order) if page < total_pages else '#' }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Schedule Call Modal -->
<div class="modal fade" id="scheduleCallModal" tabindex="-1" aria-labelledby="scheduleCallLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="scheduleCallLabel"><i class="bi bi-calendar-plus me-2 text-primary"></i>Schedule a New Call</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form hx-get="{{ form_action }}" hx-swap="innerHTML">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="scheduled_date" class="form-label fw-bold small text-secondary">Start Date</label>
                            <input type="date" class="form-control" id="scheduled_date" name="scheduled_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="scheduled_time" class="form-label fw-bold small text-secondary">Start Time</label>
                            <input type="time" class="form-control" id="scheduled_time" name="scheduled_time" required>
                        </div>
                        <div class="col-12">
                            <label for="phone" class="form-label fw-bold small text-secondary">Phone Number</label>
                            <div class="input-group">
                                <input type="tel" class="form-control" id="phone" name="phone" placeholder="Enter number..." required>
                                <button type="button" class="btn btn-outline-secondary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#pickContactModal">
                                    <i class="bi bi-book me-1"></i> Contacts
                                </button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="message" class="form-label fw-bold small text-secondary">Message</label>
                            <textarea class="form-control" id="message" name="message" rows="3" placeholder="Enter the message to be read..." required></textarea>
                        </div>
                    </div>
                    <div class="mt-4 d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check2-circle me-1"></i> Schedule Call
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="pickContactModal" tabindex="-1" aria-labelledby="pickContactLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="pickContactLabel"><i class="bi bi-person-lines-fill me-2 text-primary"></i>Select Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="input-group mb-4">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="pick_search" placeholder="Filter by name, surname or number..." oninput="filterPickContacts()">
                </div>
                
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <button type="button" class="btn btn-outline-primary btn-sm d-flex align-items-center" onclick="selectContact('oncall')">
                        <i class="bi bi-telephone-forward me-1"></i> Use current On-call
                    </button>
                </div>

                <div class="table-responsive rounded-3 border">
                    <table id="pick_contacts" class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for c in contacts or [] %}
                            <tr data-search="{{ (c.get('name') or '')|lower }} {{ (c.get('surname') or '')|lower }} {{ (c.get('phone_number') or '')|lower }}"
                                data-phone="{{ c.get('phone_number') }}" ondblclick="selectContactFromRow(this)" style="cursor: pointer;">
                                <td>
                                    <div class="fw-bold">{{ c.get('name') }} {{ c.get('surname') }}</div>
                                </td>
                                <td><code class="text-primary">{{ c.get('phone_number') }}</code></td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-primary select-contact-btn" data-phone="{{ c.get('phone_number') }}">Select</button>
                                </td>
                            </tr>
                        {% endfor %}
                        {% if (contacts or [])|length == 0 %}
                            <tr><td colspan="3" class="text-center text-muted py-4">No contacts found in address book</td></tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="exportModalLabel"><i class="bi bi-file-earmark-excel me-2 text-success"></i>Export to CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form action="{{ url_for('schedule_call_blueprint.export_csv') }}" method="get">
                    <div class="mb-4">
                        <label for="export-month" class="form-label fw-bold small text-secondary">Select Month and Year</label>
                        <input type="month" class="form-control form-control-lg" id="export-month" name="export_month" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-download me-2"></i>Download CSV
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let callScheduled = false;

        document.querySelector('#scheduleCallModal form').addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.xhr.responseText.trim() === "Scheduled OK") {
                callScheduled = true;
                const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleCallModal'));
                if (modal) modal.hide();
                showToast('Success', 'Call scheduled successfully', 'success');
                setTimeout(() => window.location.reload(), 1500);
            }
        });

        document.querySelectorAll('.select-contact-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectContact(this.dataset.phone);
            });
        });
    });

    function selectContact(phone){
        const input = document.getElementById('phone');
        if (input){ 
            input.value = phone || ''; 
            input.dispatchEvent(new Event('input')); 
            input.focus(); 
        }

        const pickEl = document.getElementById('pickContactModal');
        const pickInst = bootstrap.Modal.getInstance(pickEl);
        if (pickInst) pickInst.hide();
        
        const schedEl = document.getElementById('scheduleCallModal');
        const schedInst = bootstrap.Modal.getInstance(schedEl) || new bootstrap.Modal(schedEl);
        schedInst.show();
    }

    function filterPickContacts(){
        const q = (document.getElementById('pick_search').value || '').toLowerCase();
        document.querySelectorAll('#pick_contacts tbody tr').forEach(tr => {
            const hay = tr.getAttribute('data-search') || '';
            tr.style.display = !q || hay.includes(q) ? '' : 'none';
        });
    }

    function selectContactFromRow(tr){ 
        const phone = tr.getAttribute('data-phone'); 
        selectContact(phone); 
    }
</script>
{% endblock %}
