{% extends "base.html" %}

{% block title %}py-phone-caller PBX Events{% endblock %}

{% block content %}
<div class="container-fluid main-container px-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="page-header mb-0 text-start">PBX WebSocket Events</h2>
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="bi bi-file-earmark-excel me-1"></i> Export CSV
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-body p-3">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <form method="get" action="{{ url_for('ws_events_blueprint.ws_events') }}" class="d-flex">
                        <input type="hidden" name="per_page" value="{{ per_page }}">
                        <input type="hidden" name="sort_by" value="{{ sort_by }}">
                        <input type="hidden" name="sort_order" value="{{ sort_order }}">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                            <input class="form-control border-start-0 ps-0" type="search" placeholder="Search WebSocket events..."
                                   aria-label="Search" name="search" value="{{ search_query }}">
                            {% if search_query %}
                            <a href="{{ url_for('ws_events_blueprint.ws_events', per_page=per_page, sort_by=sort_by, sort_order=sort_order) }}"
                               class="btn btn-outline-secondary d-flex align-items-center"><i class="bi bi-x-lg"></i></a>
                            {% endif %}
                            <button class="btn btn-primary px-4" type="submit">Search</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container table-responsive border-0 shadow-sm">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th style="width: 150px;">
                    <a href="{{ url_for('ws_events_blueprint.ws_events', sort_by='timestamp', sort_order='asc' if sort_by != 'timestamp' or sort_order == 'desc' else 'desc', page=page, per_page=per_page, search=search_query) }}" class="text-dark text-decoration-none d-flex align-items-center gap-1">
                        Time
                        {% if sort_by == 'timestamp' %}
                            <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}-short text-primary"></i>
                        {% endif %}
                    </a>
                </th>
                <th style="width: 180px;">
                    <a href="{{ url_for('ws_events_blueprint.ws_events', sort_by='event_type', sort_order='asc' if sort_by != 'event_type' or sort_order == 'desc' else 'desc', page=page, per_page=per_page, search=search_query) }}" class="text-dark text-decoration-none d-flex align-items-center gap-1">
                        Event Type
                        {% if sort_by == 'event_type' %}
                            <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}-short text-primary"></i>
                        {% endif %}
                    </a>
                </th>
                <th style="width: 250px;">
                    <a href="{{ url_for('ws_events_blueprint.ws_events', sort_by='asterisk_chan', sort_order='asc' if sort_by != 'asterisk_chan' or sort_order == 'desc' else 'desc', page=page, per_page=per_page, search=search_query) }}" class="text-dark text-decoration-none d-flex align-items-center gap-1">
                        Asterisk Channel
                        {% if sort_by == 'asterisk_chan' %}
                            <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}-short text-primary"></i>
                        {% endif %}
                    </a>
                </th>
                <th>JSON Payload</th>
            </tr>
            </thead>
            <tbody>
            {% for event in paginated_data %}
            <tr>
                <td class="small text-nowrap"><span class="badge bg-light text-dark border">{{ event.formatted_time }}</span></td>
                <td><span class="badge bg-{{ event.event_color }}-subtle text-{{ event.event_color }} border border-{{ event.event_color }}-subtle">{{ event.event_type }}</span></td>
                <td class="small text-muted text-break">
                    {{ event.asterisk_chan }}
                    <div class="x-small text-muted mt-1" style="font-size: 0.65rem;">ID: {{ event.id[:8] }}...</div>
                </td>
                <td class="text-start">
                    <div class="json-container">
                        <pre class="font-monospace small text-break p-3 bg-light rounded json-payload mb-0"><code>{{ event.json_data }}</code></pre>
                        <button class="btn btn-sm btn-outline-primary copy-btn" title="Copy JSON" onclick="copyToClipboard(this)">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% if paginated_data|length == 0 %}
            <tr>
                <td colspan="5" class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No WebSocket events found{% if search_query %} for "{{ search_query }}"{% endif %}
                </td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination & Items per page -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 gap-3">
        <div class="order-2 order-md-1">
            <form method="get" action="{{ url_for('ws_events_blueprint.ws_events') }}" class="d-flex align-items-center">
                {% if search_query %}<input type="hidden" name="search" value="{{ search_query }}">{% endif %}
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                <input type="hidden" name="sort_order" value="{{ sort_order }}">
                <div class="input-group input-group-sm">
                    <label class="input-group-text bg-light border-end-0" for="items-per-page">Items per page:</label>
                    <select class="form-select border-start-0" id="items-per-page" name="per_page" onchange="this.form.submit()">
                        {% for option in [5, 10, 25, 50, 100] %}
                        <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>

        {% if total_pages > 1 %}
        <nav aria-label="Page navigation" class="order-1 order-md-2">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('ws_events_blueprint.ws_events', page=page-1, per_page=per_page, search=search_query, sort_by=sort_by, sort_order=sort_order) if page > 1 else '#' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('ws_events_blueprint.ws_events', page=p, per_page=per_page, search=search_query, sort_by=sort_by, sort_order=sort_order) }}">{{ p }}</a>
                </li>
                {% endfor %}
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('ws_events_blueprint.ws_events', page=page+1, per_page=per_page, search=search_query, sort_by=sort_by, sort_order=sort_order) if page < total_pages else '#' }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="exportModalLabel"><i class="bi bi-file-earmark-excel me-2 text-success"></i>Export to CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form action="{{ url_for('ws_events_blueprint.export_csv') }}" method="get">
                    <div class="mb-4">
                        <label for="export-month" class="form-label fw-bold small text-secondary">Select Month and Year</label>
                        <input type="month" class="form-control form-control-lg" id="export-month" name="export_month" required>
                        <div class="form-text mt-2">Data is exported one month at a time for optimal performance.</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-download me-2"></i>Download CSV
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(btn) {
        const jsonContainer = btn.closest('.json-container');
        const codeElement = jsonContainer.querySelector('.json-payload code');
        const text = codeElement ? codeElement.innerText : '';
        if (!text) return;
        
        const originalHTML = btn.innerHTML;
        
        const successAction = () => {
            btn.innerHTML = '<i class="bi bi-check2 text-success"></i>';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 2000);
            if (typeof showToast === 'function') {
                showToast('Copied', 'JSON payload copied to clipboard', 'success');
            }
        };

        const fallbackCopy = () => {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) {
                    successAction();
                } else {
                    throw new Error('execCommand copy was unsuccessful');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                if (typeof showToast === 'function') {
                    showToast('Error', 'Failed to copy to clipboard', 'danger');
                }
            }
        };

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text)
                .then(successAction)
                .catch(err => {
                    console.warn('Navigator clipboard failed, trying fallback:', err);
                    fallbackCopy();
                });
        } else {
            fallbackCopy();
        }
    }
</script>
{% endblock %}
