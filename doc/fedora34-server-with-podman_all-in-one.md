## Fedora 34 Server installation 

> Draft - Work In Progress













> git clone stuff

[fedora@fedora ~]$ sudo -i 

[root@fedora ~]# cd /opt/

[root@fedora opt]# mkdir -p /opt/py-phone-caller/config

[root@fedora opt]# chown -R daemon:fedora /opt/py-phone-caller

[root@fedora opt]# chmod 750 /opt/py-phone-caller

[root@fedora py-phone-caller]# vim /opt/py-phone-caller/config/caller_config.toml 
[...]

[root@fedora py-phone-caller]# chown g+w /opt/py-phone-caller/config/caller_config.toml 




> the py-phone-caller netork

* Docker network: py-phone-caller
   * "Subnet": "172.19.0.0/24",
   * Can be created with: podman network create --subnet=172.19.0.0/24 py-phone-caller
    
    
> The DB Stuff!

[fedora@fedora ~]$ podman volume create pgdata
pgdata

[fedora@fedora ~]$ podman run -d --name=postgres_13 --network=py-phone-caller \
  --ip=172.19.0.50 \
  --restart=always \
  -e POSTGRES_PASSWORD=SWaaDvuf9zemkoCkkFhyo0HWx9zWApluiI9JS0 \
  -e PGDATA=/var/lib/postgresql/data/pgdata \
  -v pgdata:/var/lib/postgresql/data \
  docker.io/library/postgres:13.3-alpine3.14


[fedora@fedora ~]$ podman cp /opt/py-phone-caller/assets/DB postgres_13:/tmp/

[fedora@fedora ~]$ podman exec -it postgres_13 bash
bash-5.1# su - postgres

c2fdf4fbf77c:~$ 

c2fdf4fbf77c:~$ ls /tmp/DB/
db-role.sql    db-schema.sql



c2fdf4fbf77c:~$ cat /tmp/DB/db-role.sql 
-- This file should by used before 'db-schema.sql'
-- Please change the password with another of your choice (it should be strong).
-- Later the password is needed in the 'caller_config.toml' file

CREATE DATABASE py_phone_caller;
CREATE ROLE py_phone_caller with LOGIN ENCRYPTED PASSWORD '.-7=9|W_8YzIC*p[/9)D"d6!s*{.DD0W1Mi2*^';
GRANT ALL PRIVILEGES ON DATABASE py_phone_caller TO py_phone_caller;


c2fdf4fbf77c:~$ psql -f /tmp/DB/db-role.sql 
CREATE DATABASE
CREATE ROLE
GRANT

c2fdf4fbf77c:~$ psql -f /tmp/DB/db-schema.sql -d py_phone_caller
SET
SET
SET
SET
SET
CREATE EXTENSION
COMMENT
SET
SET
SET
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER TABLE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER TABLE
ALTER SEQUENCE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
REVOKE
REVOKE
GRANT
GRANT










> start the containers 



Run the bash script... 


> Manage the Containers with Systemd 



[fedora@fedora ~]$ podman generate systemd --name asterisk_ws_monitor
# container-asterisk_ws_monitor.service
# autogenerated by Podman 3.2.2
# Mon Jul 19 07:10:12 CEST 2021

[Unit]
Description=Podman container-asterisk_ws_monitor.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start asterisk_ws_monitor
ExecStop=/usr/bin/podman stop -t 10 asterisk_ws_monitor
ExecStopPost=/usr/bin/podman stop -t 10 asterisk_ws_monitor
PIDFile=/run/user/1000/containers/overlay-containers/b8612ce99726ac6e423797f97577f45f695237b993799e2eac1439f15f89189b/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target



[fedora@fedora ~]$ podman generate systemd --name asterisk_call
# container-asterisk_call.service
# autogenerated by Podman 3.2.2
# Mon Jul 19 07:21:33 CEST 2021

[Unit]
Description=Podman container-asterisk_call.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start asterisk_call
ExecStop=/usr/bin/podman stop -t 10 asterisk_call
ExecStopPost=/usr/bin/podman stop -t 10 asterisk_call
PIDFile=/run/user/1000/containers/overlay-containers/a003016a8db91915c2b4955ebb2e7060f8788a183eeff98e180633e54359aafc/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target


[fedora@fedora ~]$ podman generate systemd --name asterisk_recall
# container-asterisk_recall.service
# autogenerated by Podman 3.2.2
# Mon Jul 19 07:22:27 CEST 2021

[Unit]
Description=Podman container-asterisk_recall.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start asterisk_recall
ExecStop=/usr/bin/podman stop -t 10 asterisk_recall
ExecStopPost=/usr/bin/podman stop -t 10 asterisk_recall
PIDFile=/run/user/1000/containers/overlay-containers/78f672357ef7803a40e0ba2844e908e3c7827e188a6915149a65cef88d73329c/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target


[fedora@fedora ~]$ podman generate systemd --name asterisk_call_register
# container-asterisk_call_register.service
# autogenerated by Podman 3.2.2
# Mon Jul 19 07:23:03 CEST 2021

[Unit]
Description=Podman container-asterisk_call_register.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start asterisk_call_register
ExecStop=/usr/bin/podman stop -t 10 asterisk_call_register
ExecStopPost=/usr/bin/podman stop -t 10 asterisk_call_register
PIDFile=/run/user/1000/containers/overlay-containers/2ba8c870e3186e2db09ff1e2a55d3fa878d3ff362449c6ace6e497c5750c10ef/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target



[fedora@fedora ~]$ podman generate systemd --name caller_prometheus_webhook
# container-caller_prometheus_webhook.service
# autogenerated by Podman 3.2.2
# Mon Jul 19 07:23:42 CEST 2021

[Unit]
Description=Podman container-caller_prometheus_webhook.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start caller_prometheus_webhook
ExecStop=/usr/bin/podman stop -t 10 caller_prometheus_webhook
ExecStopPost=/usr/bin/podman stop -t 10 caller_prometheus_webhook
PIDFile=/run/user/1000/containers/overlay-containers/145cb105bbb8c9b44b5db41b84dc2119ab286c1156cdaa838262b40c3c5fca4b/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target


[fedora@fedora ~]$ podman generate systemd --name caller_sms
# container-caller_sms.service
# autogenerated by Podman 3.2.2
# Mon Jul 19 07:24:47 CEST 2021

[Unit]
Description=Podman container-caller_sms.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start caller_sms
ExecStop=/usr/bin/podman stop -t 10 caller_sms
ExecStopPost=/usr/bin/podman stop -t 10 caller_sms
PIDFile=/run/user/1000/containers/overlay-containers/40a4fe70213ee630ddab182f23fc2b39c8992346fd9158251ae37c7b95f67c99/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target


[fedora@fedora ~]$ podman generate systemd --name generate_audio
# container-generate_audio.service
# autogenerated by Podman 3.2.2
# Mon Jul 19 07:25:11 CEST 2021

[Unit]
Description=Podman container-generate_audio.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman start generate_audio
ExecStop=/usr/bin/podman stop -t 10 generate_audio
ExecStopPost=/usr/bin/podman stop -t 10 generate_audio
PIDFile=/run/user/1000/containers/overlay-containers/2ada849c4643586cc5f04825d19e064359c2173860c28e2f2290a44886a91809/userdata/conmon.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target






> Enabling the user unit files


[fedora@fedora ~]$ mkdir -p /home/fedora/.config/systemd/user


[fedora@fedora ~]$ systemctl --user enable container-asterisk_ws_monitor.service
Created symlink /home/fedora/.config/systemd/user/multi-user.target.wants/container-asterisk_ws_monitor.service → /home/fedora/.config/systemd/user/container-asterisk_ws_monitor.service.
Created symlink /home/fedora/.config/systemd/user/default.target.wants/container-asterisk_ws_monitor.service → /home/fedora/.config/systemd/user/container-asterisk_ws_monitor.service.

[fedora@fedora ~]$ systemctl --user enable container-asterisk_call.service 
Created symlink /home/fedora/.config/systemd/user/multi-user.target.wants/container-asterisk_call.service → /home/fedora/.config/systemd/user/container-asterisk_call.service.
Created symlink /home/fedora/.config/systemd/user/default.target.wants/container-asterisk_call.service → /home/fedora/.config/systemd/user/container-asterisk_call.service.

[fedora@fedora ~]$ systemctl --user enable container-asterisk_recall.service 
Created symlink /home/fedora/.config/systemd/user/multi-user.target.wants/container-asterisk_recall.service → /home/fedora/.config/systemd/user/container-asterisk_recall.service.
Created symlink /home/fedora/.config/systemd/user/default.target.wants/container-asterisk_recall.service → /home/fedora/.config/systemd/user/container-asterisk_recall.service.

[fedora@fedora ~]$ systemctl --user enable container-asterisk_call_register.service 
Created symlink /home/fedora/.config/systemd/user/multi-user.target.wants/container-asterisk_call_register.service → /home/fedora/.config/systemd/user/container-asterisk_call_register.service.
Created symlink /home/fedora/.config/systemd/user/default.target.wants/container-asterisk_call_register.service → /home/fedora/.config/systemd/user/container-asterisk_call_register.service.

[fedora@fedora ~]$ systemctl --user enable container-caller_prometheus_webhook.service 
Created symlink /home/fedora/.config/systemd/user/multi-user.target.wants/container-caller_prometheus_webhook.service → /home/fedora/.config/systemd/user/container-caller_prometheus_webhook.service.
Created symlink /home/fedora/.config/systemd/user/default.target.wants/container-caller_prometheus_webhook.service → /home/fedora/.config/systemd/user/container-caller_prometheus_webhook.service.

[fedora@fedora ~]$ systemctl --user enable container-caller_sms.service 
Created symlink /home/fedora/.config/systemd/user/multi-user.target.wants/container-caller_sms.service → /home/fedora/.config/systemd/user/container-caller_sms.service.
Created symlink /home/fedora/.config/systemd/user/default.target.wants/container-caller_sms.service → /home/fedora/.config/systemd/user/container-caller_sms.service.

[fedora@fedora ~]$ systemctl --user enable container-generate_audio.service 
Created symlink /home/fedora/.config/systemd/user/multi-user.target.wants/container-generate_audio.service → /home/fedora/.config/systemd/user/container-generate_audio.service.
Created symlink /home/fedora/.config/systemd/user/default.target.wants/container-generate_audio.service → /home/fedora/.config/systemd/user/container-generate_audio.service.






> Firewall stuff in order to get it working from the LAN

[root@fedora ~]# firewall-cmd --new-zone=py-phone-caller --permanent
success

[root@fedora ~]# firewall-cmd --zone=py-phone-caller --add-source=192.168.122.0/24 --permanent
success

[root@fedora ~]# firewall-cmd --zone=py-phone-caller --add-port=8080/tcp --permanent
success

[root@fedora ~]# firewall-cmd --zone=py-phone-caller --add-port=8081/tcp --permanent
success

[root@fedora ~]# firewall-cmd --zone=py-phone-caller --add-port=8082/tcp --permanent
success

[root@fedora ~]# firewall-cmd --zone=py-phone-caller --add-port=8084/tcp --permanent
success

[root@fedora ~]# firewall-cmd --zone=py-phone-caller --add-port=8085/tcp --permanent
success

[root@fedora ~]# firewall-cmd --get-active-zones
FedoraServer
  interfaces: enp1s0
py-phone-caller
  sources: 192.168.122.0/24